#!/bin/sh

load_env() {
  local env_file="$(git rev-parse --show-toplevel)/.env"
  [ -f "$env_file" ] && source "$env_file" || { echo "Error: .env file not found."; exit 1; }
  : "${API_KEY:?Missing API_KEY}"; : "${TOKEN:?Missing TOKEN}"; : "${BOARD_NAME:?Missing BOARD_NAME}"; : "${GITHUB_REPO:?Missing GITHUB_REPO}"
}

validate_commit_msg() {
  local commit_msg=$(cat "$1")
  echo "$commit_msg" | grep -qP '^\[\d+\]\[[A-Za-z]+\]' || { echo "Error: Commit message must include [id][Type]."; exit 1; }
  echo "$commit_msg"
}

fetch_board_id() {
  local boards_url=$(echo "$BOARDS_URL" | sed "s/{API_KEY}/$API_KEY/;s/{TOKEN}/$TOKEN/")
  curl -s "$boards_url" | jq -r ".[] | select(.name == \"$BOARD_NAME\") | .id"
}

fetch_card_details() {
  local cards_url=$(echo "$CARDS_URL" | sed "s/{BOARD_ID}/$1/;s/{API_KEY}/$API_KEY/;s/{TOKEN}/$TOKEN/")
  local card_data=$(curl -s "$cards_url" | jq -r ".[] | select(.idShort == $2)")
  echo "$card_data"
}

add_comment() {
  local comment_url=$(echo "$COMMENT_URL" | sed "s/{CARD_ID}/$1/;s/{API_KEY}/$API_KEY/;s/{TOKEN}/$TOKEN/")
  curl -s -X POST -H "Content-Type: application/json" -d "{\"text\": \"$2\"}" "$comment_url" > /dev/null
}

add_label() {
  local label_id=$(curl -s "https://api.trello.com/1/boards/$1/labels?key=$API_KEY&token=$TOKEN" | jq -r ".[] | select(.name == \"$2\") | .id")
  if [ -z "$label_id" ]; then
    label_id=$(curl -s -X POST -H "Content-Type: application/json" -d "{\"name\": \"$2\", \"color\": \"$3\"}" "https://api.trello.com/1/boards/$1/labels?key=$API_KEY&token=$TOKEN" | jq -r '.id')
  fi
  curl -s -X POST -H "Content-Type: application/json" -d "{\"value\": \"$label_id\"}" "https://api.trello.com/1/cards/$4/idLabels?key=$API_KEY&token=$TOKEN" > /dev/null
}

load_env
commit_msg=$(validate_commit_msg "$1")
id_short=$(echo "$commit_msg" | grep -oP '^\[\d+\]' | grep -oP '\d+')
board_id=$(fetch_board_id) || { echo "Error: Trello board not found."; exit 1; }
card_details=$(fetch_card_details "$board_id" "$id_short") || { echo "Error: Trello card not found."; exit 1; }
card_id=$(echo "$card_details" | jq -r '.id') || { echo "Error: Trello card ID missing."; exit 1; }
short_link=$(echo "$card_details" | jq -r '.shortLink')
repo_url="https://github.com/$GITHUB_REPO/commit/$(git rev-parse HEAD)"
add_comment "$card_id" "Commit linked: $commit_msg ($repo_url)"
add_label "$board_id" "Commit Linked" "green" "$card_id"
echo "Commit successfully linked to Trello card $id_short."
